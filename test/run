@echo off
#/bin/sh
clear 

script_path=$(pwd)/scripts

all=true;
debug=false;
tests=()

for var in "$@"; do
    if [ "$var" = "-dbg" ]; then debug=true; 
    else all=false; tests+=("--test $script_path/$var");
    fi
done

echo Building libs...
pushd .
cd lib
make clean 
make
popd

echo Building tests...
make clean 
if ( $debug ); then
    make DEBUG=1
else 
    make
fi;

# copy over libs
yes | cp -rf lib/linux/. build
cd build

if ( $all ); then
    echo Running all tests
    valgrind  --main-stacksize=1048576 --tool=memcheck --leak-check=full --show-leak-kinds=all \
    ./aug_test --test_native $script_path/test_native --test_all $(ls $script_path/test_*)
else 
    echo Running test
    valgrind  --main-stacksize=1048576 --tool=memcheck --leak-check=full --show-leak-kinds=all \
    ./aug_test --dump --verbose $tests
fi;

